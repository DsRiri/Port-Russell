<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="/" class="logo">Port Russell</a>
                <ul>
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/catways">Catways</a></li>
                    <li><a href="/reservations">R√©servations</a></li>
                    <li><a href="/documentation">Documentation</a></li>
                    <li><a href="/logout">D√©connexion</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="dashboard-header">
            <h1>Tableau de bord</h1>
            <p>Bienvenue, <strong><%= user.name %></strong></p>
        </div>

        <% if (success) { %>
            <div class="alert success"><%= success %></div>
        <% } %>
        <% if (error) { %>
            <div class="alert error"><%= error %></div>
        <% } %>

        <div class="dashboard-grid">
            <!-- SECTION UTILISATEURS -->
            <section class="dashboard-section">
                <h2>üë§ Gestion des utilisateurs</h2>

                <!-- CREER utilisateur -->
                <div class="form-card">
                    <h3>Cr√©er un utilisateur</h3>
                    <div class="form-group">
                        <input type="text" id="userName" placeholder="Nom" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="userEmail" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="userPassword" placeholder="Mot de passe" required minlength="6">
                    </div>
                    <button type="button" class="btn btn-primary btn-block" onclick="createUser()">Cr√©er</button>
                </div>

                <!-- SUPPRIMER utilisateur -->
                <div class="form-card">
                    <h3>Supprimer un utilisateur</h3>
                    <div class="form-group">
                        <input type="text" id="deleteUserId" placeholder="ID de l'utilisateur" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-block" onclick="deleteUser()">Supprimer</button>
                </div>
            </section>

            <!-- SECTION CATWAYS -->
            <section class="dashboard-section">
                <h2>üö§ Gestion des catways</h2>

                <!-- CREER catway -->
                <div class="form-card">
                    <h3>Cr√©er un catway</h3>
                    <div class="form-group">
                        <input type="number" id="catwayNumber" placeholder="Num√©ro" required>
                    </div>
                    <div class="form-group">
                        <select id="catwayType" required>
                            <option value="long">Long</option>
                            <option value="short">Court</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="catwayState" placeholder="√âtat" required></textarea>
                    </div>
                    <button type="button" class="btn btn-primary btn-block" onclick="createCatway()">Cr√©er</button>
                </div>

                <!-- MODIFIER √©tat catway -->
                <div class="form-card">
                    <h3>Modifier l'√©tat d'un catway</h3>
                    <div class="form-group">
                        <input type="text" id="updateCatwayId" placeholder="ID du catway" required>
                    </div>
                    <div class="form-group">
                        <textarea id="updateCatwayState" placeholder="Nouvel √©tat" required></textarea>
                    </div>
                    <button type="button" class="btn btn-warning btn-block" onclick="updateCatway()">Modifier</button>
                </div>

                <!-- SUPPRIMER catway -->
                <div class="form-card">
                    <h3>Supprimer un catway</h3>
                    <div class="form-group">
                        <input type="text" id="deleteCatwayId" placeholder="ID du catway" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-block" onclick="deleteCatway()">Supprimer</button>
                </div>
            </section>
        </div>

        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <a href="/catways" class="btn btn-secondary">Voir tous les catways</a>
            <a href="/reservations" class="btn btn-secondary">Voir toutes les r√©servations</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>¬© 2026 Port Russell</p>
        </div>
    </footer>

    <script>
        // R√©cup√©ration du token depuis la session
        async function getToken() {
            try {
                const res = await fetch('/api/token', { credentials: 'include' });
                const data = await res.json();
                return data.token || '';
            } catch (err) {
                console.error('Erreur token:', err);
                return '';
            }
        }

        const API_BASE = '/api';

        // ===== UTILISATEURS =====
        async function createUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;

            if (!name || !email || !password) {
                alert('Tous les champs sont requis');
                return;
            }

            try {
                const token = await getToken();
                const res = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const result = await res.json();
                window.location.href = result.success 
                    ? '/dashboard?success=Utilisateur cr√©√©'
                    : '/dashboard?error=' + encodeURIComponent(result.error);
            } catch (err) {
                window.location.href = '/dashboard?error=Erreur r√©seau';
            }
        }

        async function deleteUser() {
            const userId = document.getElementById('deleteUserId').value;
            if (!userId) return alert('ID requis');
            if (!confirm('Supprimer cet utilisateur ?')) return;

            try {
                const token = await getToken();
                const res = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await res.json();
                window.location.href = result.success
                    ? '/dashboard?success=Utilisateur supprim√©'
                    : '/dashboard?error=' + encodeURIComponent(result.error);
            } catch (err) {
                window.location.href = '/dashboard?error=Erreur r√©seau';
            }
        }

        // ===== CATWAYS =====
        async function createCatway() {
            const catwayNumber = parseInt(document.getElementById('catwayNumber').value);
            const type = document.getElementById('catwayType').value;
            const catwayState = document.getElementById('catwayState').value;

            if (!catwayNumber || !type || !catwayState) {
                alert('Tous les champs sont requis');
                return;
            }

            try {
                const token = await getToken();
                const res = await fetch(`${API_BASE}/catways`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ catwayNumber, type, catwayState })
                });

                const result = await res.json();
                window.location.href = result.success
                    ? '/dashboard?success=Catway cr√©√©'
                    : '/dashboard?error=' + encodeURIComponent(result.error);
            } catch (err) {
                window.location.href = '/dashboard?error=Erreur r√©seau';
            }
        }

        async function updateCatway() {
            const catwayId = document.getElementById('updateCatwayId').value;
            const catwayState = document.getElementById('updateCatwayState').value;

            if (!catwayId || !catwayState) {
                alert('Tous les champs sont requis');
                return;
            }

            try {
                const token = await getToken();
                const res = await fetch(`${API_BASE}/catways/${catwayId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ catwayState })
                });

                const result = await res.json();
                window.location.href = result.success
                    ? '/dashboard?success=√âtat modifi√©'
                    : '/dashboard?error=' + encodeURIComponent(result.error);
            } catch (err) {
                window.location.href = '/dashboard?error=Erreur r√©seau';
            }
        }

        async function deleteCatway() {
            const catwayId = document.getElementById('deleteCatwayId').value;
            if (!catwayId) return alert('ID requis');
            if (!confirm('Supprimer ce catway ? Toutes ses r√©servations seront supprim√©es.')) return;

            try {
                const token = await getToken();
                const res = await fetch(`${API_BASE}/catways/${catwayId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await res.json();
                window.location.href = result.success
                    ? '/dashboard?success=Catway supprim√©'
                    : '/dashboard?error=' + encodeURIComponent(result.error);
            } catch (err) {
                window.location.href = '/dashboard?error=Erreur r√©seau';
            }
        }
    </script>
</body>
</html>